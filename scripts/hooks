#!/usr/bin/env bash


libash_hooks=(chpwd periodic)

# chpwd_hook will return true when you change directory
chpwd_hook () {
  local chpwd=1
  [[ $olddir ]] && [[ $olddir != "$PWD" ]] && chpwd=0
  olddir=$PWD
  return $chpwd
}
chpwd_hook_actions=()
# sample hook:
# git rev-parse 2> /dev/null && git status

periodic_hook () {
  : todo
}
periodic_hook_actions=()

libash_handle_hook () {
  # hardcoded :(
  case $1 in
    chpwd) for i in "${chpwd_hook_actions[@]}"; do eval "$i"; done ;;
    periodic) for i in "${periodic_hook_actions[@]}"; do eval "$i"; done ;;
  esac
}

libash_hook_handler () {
  for i in "${libash_hooks[@]}"; do "$i"_hook && libash_handle_hook "$i"; done
}

add_to_hook () {
  (($# != 2)) && return 1
  case $1 in
    chpwd) chpwd_hook_actions+=("$2");;
    periodic) periodic_hook_actions+=("$2");;
    *) echo Unknown handle; return 1;;
  esac
  read -erp 'Add permanently? '
  if [[ $REPLY = [Yy]* ]]; then
    echo "${1}_hook_actions+=(\"$2\")" >> ~/.config/libash
  fi
  return 0
}

PROMPT_COMMAND=libash_hook_handler

# thanks to dualbus!
command_not_found_handle () {
  case $1 in
    git@*) git clone "$@";;   # autoclone
    *) printf "%s: %s: command not found\n" "$0" "$1" >&2
      return 127
  esac
}
